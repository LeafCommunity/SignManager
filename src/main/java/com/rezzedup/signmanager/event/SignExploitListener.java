package com.rezzedup.signmanager.event;

import com.rezzedup.signmanager.SignManager;
import org.bukkit.Bukkit;
import org.bukkit.ChatColor;
import org.bukkit.Location;
import org.bukkit.configuration.ConfigurationSection;
import org.bukkit.event.EventHandler;
import org.bukkit.event.Listener;
import org.bukkit.event.block.SignChangeEvent;

public class SignExploitListener implements Listener
{
    private final SignManager plugin;
    
    public SignExploitListener(SignManager plugin)
    {
        this.plugin = plugin;
        Bukkit.getPluginManager().registerEvents(this, plugin);
    }
    
    @EventHandler
    public void on(SignChangeEvent event)
    {
        boolean detected = false;
        int index = 0;
        
        for (String line : event.getLines())
        {
            if (line.length() >= 20)
            {
                detected = true;
                event.setLine(index, "[err: too long]");
            }
            index += 1;
        }
        
        if (detected)
        {
            event.setCancelled(true);
    
            ConfigurationSection config = plugin.getConfig().getConfigurationSection("sign-crash");
            String name = event.getPlayer().getName();
            Location loc = event.getBlock().getLocation();
            String location = "x" + loc.getBlockX() + ", y" + loc.getBlockY() + ", z" + loc.getBlockZ() + " in world " + loc.getWorld().getName();
            String broadcast = config.getString("exploit-broadcast").replace("%player%", name).replace("%location%", location);
            String permission = config.getString("broadcast-permission");
            
            Bukkit.broadcast(ChatColor.translateAlternateColorCodes('&', broadcast), permission);
            Bukkit.dispatchCommand(Bukkit.getConsoleSender(), config.getString("exploit-punishment").replace("%player%", name));
        }
    }
}
